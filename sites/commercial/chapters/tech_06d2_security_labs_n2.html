<div class="space-y-14 animate-in fade-in duration-700">

    <!-- Top nav -->
    <section class="max-w-5xl mx-auto space-y-6">
        <div class="flex items-center justify-between gap-3 flex-col md:flex-row">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-rose-500/10 text-rose-400 border border-rose-500/20">
                    <i data-lucide="shield-alert" class="w-5 h-5"></i>
                </div>
                <div>
                    <div class="text-[10px] uppercase tracking-widest font-bold text-slate-500">Security Labs</div>
                    <h1 class="text-3xl md:text-4xl font-black text-white">N1 ‚Äî Labs 1 √† 3</h1>
                </div>
            </div>

            <div class="flex gap-2 w-full md:w-auto">
                <button
                    class="flex-1 md:flex-none px-4 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 transition-colors text-sm text-white font-bold"
                    data-page="tech_06d1_security_labs_n1">
                    <span class="inline-flex items-center gap-2"><i data-lucide="arrow-left"
                            class="w-4 h-4"></i>N1</span>
                </button>
                <button
                    class="flex-1 md:flex-none px-4 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 transition-colors text-sm text-white font-bold"
                    data-page="tech_06d_security_labs">
                    <span class="inline-flex items-center gap-2">Hub<i data-lucide="home" class="w-4 h-4"></i></span>
                </button>
            </div>
        </div>

        <div class="p-5 rounded-2xl border border-white/10 bg-slate-900/30 text-sm text-slate-300">
            <div class="flex items-start gap-3">
                <i data-lucide="info" class="w-5 h-5 text-indigo-400 mt-0.5"></i>
                <div>
                    <strong>Objectif N2 :</strong> s√©curiser les surfaces ‚Äúavanc√©es‚Äù : d√©s√©rialisation, CPI,
                    arithm√©tique.
                    <div class="text-slate-400 mt-1">
                        Les exemples ci-dessous sont con√ßus pour un <strong>repo de lab</strong> (tests de preuve), pas
                        pour des cibles r√©elles.
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- LAB 4 -->
    <section class="max-w-5xl mx-auto border-t border-white/10 pt-12 space-y-6">
        <div class="flex items-center gap-4">
            <span
                class="w-9 h-9 rounded bg-rose-500/20 text-rose-400 font-bold flex items-center justify-center border border-rose-500/30">04</span>
            <div>
                <h2 class="text-2xl font-bold text-white">Arbitrary Data Injection</h2>
                <p class="text-sm text-slate-400">D√©s√©rialisation de donn√©es sans v√©rifier le propri√©taire / le type du
                    compte.</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-5 rounded-2xl border border-rose-500/20 bg-[#0b1221]">
                <div class="text-xs font-bold text-rose-400 uppercase mb-2">üî¥ Buggy (anti-pattern)</div>
                <pre class="text-[11px] text-slate-300 overflow-x-auto font-mono leading-relaxed">
pub fn read_state(ctx: Context&lt;ReadState&gt;) -&gt; Result&lt;()&gt; {
    // ‚ö†Ô∏è "state" est raw, on lit des bytes et on interpr√®te sans owner check
    let data = ctx.accounts.state.data.borrow();
    // (parsing custom layout logic)
    Ok(())
}

#[derive(Accounts)]
pub struct ReadState&lt;'info&gt; {
    /// CHECK: unsafe
    pub state: AccountInfo&lt;'info&gt;,
}
        </pre>
            </div>

            <div class="space-y-4">
                <div class="p-5 rounded-2xl border border-white/10 bg-slate-900/30">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="alert-triangle" class="w-4 h-4 text-amber-400"></i>
                        <h3 class="font-bold text-white">Pourquoi c‚Äôest dangereux ?</h3>
                    </div>
                    <p class="text-sm text-slate-300">
                        Un compte ‚Äúfake‚Äù peut porter des bytes plausibles mais provenir d‚Äôun owner inattendu.
                        En audit : <strong>owner check</strong> avant toute interpr√©tation (d√©s√©rialisation).
                    </p>
                </div>

                <div class="p-5 rounded-2xl border border-emerald-500/20 bg-slate-900/30">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="wrench" class="w-4 h-4 text-emerald-400"></i>
                        <h3 class="font-bold text-white">Patch (typing + owner)</h3>
                    </div>
                    <pre class="text-[11px] text-emerald-300 overflow-x-auto font-mono leading-relaxed">
#[derive(Accounts)]
pub struct ReadState&lt;'info&gt; {
    pub state: Account&lt;'info, State&gt;, // ‚úÖ Anchor v√©rifie discriminator + owner
}
          </pre>
                    <p class="text-xs text-slate-400 mt-2">
                        Si vous devez rester en raw : v√©rifier <code>*state.owner == program_id</code> (ou owner
                        attendu) avant parse.
                    </p>
                </div>

                <div class="p-5 rounded-2xl border border-white/10 bg-slate-900/30">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="test-tube" class="w-4 h-4 text-amber-400"></i>
                        <h3 class="font-bold text-white">Test (squelette)</h3>
                    </div>
                    <pre class="text-[11px] text-slate-200 overflow-x-auto font-mono leading-relaxed">
it("rejects state account if owner/program_id mismatch", async () =&gt; {
  // Arrange: pass an account owned by SystemProgram or another program
  // Assert: instruction fails (owner mismatch)
});
          </pre>
                </div>
            </div>
        </div>

        <div class="p-5 rounded-2xl border border-white/10 bg-white/5">
            <div class="text-[10px] uppercase tracking-widest font-bold text-slate-500 mb-2">Checklist de sortie (Lab
                04)</div>
            <ul class="space-y-2 text-sm text-slate-300">
                <li>Le compte d‚Äô√©tat est typ√© (<code>Account&lt;State&gt;</code>) ou owner-check√© avant parse.</li>
                <li>Le test ‚Äúowner mismatch‚Äù est rouge avant patch et vert apr√®s.</li>
                <li>Aucune d√©s√©rialisation raw sans justification et invariant.</li>
            </ul>
        </div>
    </section>

    <!-- LAB 5 -->
    <section class="max-w-5xl mx-auto border-t border-white/10 pt-12 space-y-6">
        <div class="flex items-center gap-4">
            <span
                class="w-9 h-9 rounded bg-rose-500/20 text-rose-400 font-bold flex items-center justify-center border border-rose-500/30">05</span>
            <div>
                <h2 class="text-2xl font-bold text-white">Fake CPI Program</h2>
                <p class="text-sm text-slate-400">Invoquer un programme pass√© en account sans v√©rifier son Program ID.
                </p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-5 rounded-2xl border border-rose-500/20 bg-[#0b1221]">
                <div class="text-xs font-bold text-rose-400 uppercase mb-2">üî¥ Buggy (CPI)</div>
                <pre class="text-[11px] text-slate-300 overflow-x-auto font-mono leading-relaxed">
pub fn swap(ctx: Context&lt;Swap&gt;, amount: u64) -&gt; Result&lt;()&gt; {
    // ‚ö†Ô∏è token_program est un AccountInfo, pas un Program&lt;Token&gt; => spoof possible en lab.
    let ix = spl_token::instruction::transfer(
        ctx.accounts.token_program.key(),
        ctx.accounts.source.key,
        ctx.accounts.dest.key,
        ctx.accounts.authority.key,
        &[],
        amount
    )?;
    invoke(&ix, &[
        ctx.accounts.token_program.clone(),
        ctx.accounts.source.clone(),
        ctx.accounts.dest.clone(),
        ctx.accounts.authority.clone(),
    ])?;
    Ok(())
}

#[derive(Accounts)]
pub struct Swap&lt;'info&gt; {
    /// CHECK: unsafe
    pub token_program: AccountInfo&lt;'info&gt;,
    /// CHECK: simplified example
    pub source: AccountInfo&lt;'info&gt;,
    /// CHECK
    pub dest: AccountInfo&lt;'info&gt;,
    /// CHECK
    pub authority: AccountInfo&lt;'info&gt;,
}
        </pre>
            </div>

            <div class="space-y-4">
                <div class="p-5 rounded-2xl border border-white/10 bg-slate-900/30">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="shield-check" class="w-4 h-4 text-indigo-400"></i>
                        <h3 class="font-bold text-white">R√®gle d‚Äôaudit</h3>
                    </div>
                    <p class="text-sm text-slate-300">
                        Tout CPI vers Token/System/Associated Token doit pointer vers l‚ÄôID officiel.
                        Le typage Anchor (<code>Program&lt;Token&gt;</code>) est un garde-fou fort.
                    </p>
                </div>

                <div class="p-5 rounded-2xl border border-emerald-500/20 bg-slate-900/30">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="wrench" class="w-4 h-4 text-emerald-400"></i>
                        <h3 class="font-bold text-white">Patch (program id)</h3>
                    </div>
                    <pre class="text-[11px] text-emerald-300 overflow-x-auto font-mono leading-relaxed">
#[derive(Accounts)]
pub struct Swap&lt;'info&gt; {
    pub token_program: Program&lt;'info, Token&gt;, // ‚úÖ typage = ID attendu
    // (rest of the instructions)
}

// Si vous √™tes en raw:
if ctx.accounts.token_program.key() != spl_token::ID {
    return Err(ProgramError::IncorrectProgramId.into());
}
          </pre>
                </div>

                <div class="p-5 rounded-2xl border border-white/10 bg-slate-900/30">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="test-tube" class="w-4 h-4 text-amber-400"></i>
                        <h3 class="font-bold text-white">Test (squelette)</h3>
                    </div>
                    <pre class="text-[11px] text-slate-200 overflow-x-auto font-mono leading-relaxed">
it("rejects CPI if token_program is not the official SPL Token program", async () =&gt; {
  // Arrange: pass a dummy program id in lab harness
  // Assert: incorrect program id error
});
          </pre>
                </div>
            </div>
        </div>

        <div class="p-5 rounded-2xl border border-white/10 bg-white/5">
            <div class="text-[10px] uppercase tracking-widest font-bold text-slate-500 mb-2">Checklist de sortie (Lab
                05)</div>
            <ul class="space-y-2 text-sm text-slate-300">
                <li>Les programmes CPI sont typ√©s (<code>Program&lt;T&gt;</code>) ou v√©rifi√©s via
                    <code>spl_token::ID</code>.
                </li>
                <li>Le test ‚Äúfake program id‚Äù est rouge avant patch et vert apr√®s.</li>
                <li>Les comptes CPI (source/dest/authority/mint) sont coh√©rents et valid√©s.</li>
            </ul>
        </div>
    </section>

    <!-- LAB 6 -->
    <section class="max-w-5xl mx-auto border-t border-white/10 pt-12 space-y-6">
        <div class="flex items-center gap-4">
            <span
                class="w-9 h-9 rounded bg-rose-500/20 text-rose-400 font-bold flex items-center justify-center border border-rose-500/30">06</span>
            <div>
                <h2 class="text-2xl font-bold text-white">Integer Overflow & Rounding</h2>
                <p class="text-sm text-slate-400">Wrap-around en release + erreurs d‚Äôarrondi qui cassent les invariants.
                </p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-5 rounded-2xl border border-rose-500/20 bg-[#0b1221]">
                <div class="text-xs font-bold text-rose-400 uppercase mb-2">üî¥ Buggy (math)</div>
                <pre class="text-[11px] text-slate-300 overflow-x-auto font-mono leading-relaxed">
pub fn mint_shares(amount: u64, price: u64) -&gt; u64 {
    // ‚ö†Ô∏è overflow possible en release + rounding non ma√Ætris√©
    (amount * 1_000_000) / price
}
        </pre>
                <p class="text-xs text-slate-400 mt-2">
                    Indice : multiplications / divisions sur u64 + facteurs d‚Äô√©chelle sans checks = danger.
                </p>
            </div>

            <div class="space-y-4">
                <div class="p-5 rounded-2xl border border-white/10 bg-slate-900/30">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="calculator" class="w-4 h-4 text-indigo-400"></i>
                        <h3 class="font-bold text-white">Invariant √† expliciter</h3>
                    </div>
                    <p class="text-sm text-slate-300">
                        D√©finir ce qui doit rester vrai : bornes, conservation, monotonicit√©.
                        Ensuite, utiliser des op√©rations <strong>checked</strong> et tester les coins-cases.
                    </p>
                </div>

                <div class="p-5 rounded-2xl border border-emerald-500/20 bg-slate-900/30">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="wrench" class="w-4 h-4 text-emerald-400"></i>
                        <h3 class="font-bold text-white">Patch (checked + erreurs explicites)</h3>
                    </div>
                    <pre class="text-[11px] text-emerald-300 overflow-x-auto font-mono leading-relaxed">
pub fn mint_shares(amount: u64, price: u64) -&gt; Result&lt;u64&gt; {
    let scaled = amount
        .checked_mul(1_000_000)
        .ok_or(ErrorCode::MathOverflow)?;
    let shares = scaled
        .checked_div(price)
        .ok_or(ErrorCode::DivisionByZero)?;
    Ok(shares)
}
          </pre>
                    <p class="text-xs text-slate-400 mt-2">
                        √Ä compl√©ter : strat√©gie d‚Äôarrondi (floor/ceil/bankers) + tests d√©di√©s.
                    </p>
                </div>

                <div class="p-5 rounded-2xl border border-white/10 bg-slate-900/30">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="test-tube" class="w-4 h-4 text-amber-400"></i>
                        <h3 class="font-bold text-white">Tests (squelette)</h3>
                    </div>
                    <pre class="text-[11px] text-slate-200 overflow-x-auto font-mono leading-relaxed">
it("fails on multiplication overflow", async () =&gt; {
  // amount near u64::MAX should throw MathOverflow
});

it("handles rounding edge cases deterministically", async () =&gt; {
  // price values that create fractional shares -> expected rounding policy
});
          </pre>
                </div>
            </div>
        </div>

        <div class="p-5 rounded-2xl border border-white/10 bg-white/5">
            <div class="text-[10px] uppercase tracking-widest font-bold text-slate-500 mb-2">Checklist de sortie (Lab
                06)</div>
            <ul class="space-y-2 text-sm text-slate-300">
                <li>Op√©rations sensibles en <code>checked_*</code> + erreurs explicites.</li>
                <li>Politique d‚Äôarrondi document√©e et test√©e.</li>
                <li>Coins-cases : 0/1/max/limites/arrondis ‚Üí tests automatis√©s.</li>
            </ul>
        </div>
    </section>

    <!-- Footer nav -->
    <section class="max-w-5xl mx-auto pt-2">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <button
                class="text-left p-4 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition-colors"
                data-page="tech_06d1_security_labs_n1">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-[10px] uppercase tracking-widest text-slate-500 mb-1">Retour</div>
                        <div class="text-white font-bold">N1 ‚Äî Labs 1‚Äì3</div>
                    </div>
                    <i data-lucide="arrow-left" class="w-5 h-5 text-slate-500"></i>
                </div>
            </button>

            <div class="p-4 rounded-2xl border border-white/10 bg-slate-900/30">
                <div class="text-[10px] uppercase tracking-widest text-slate-500 mb-1 font-bold">Gate</div>
                <div class="text-sm text-slate-300">
                    N2 valid√© si vous avez <strong>3 tests rouges</strong> + <strong>3 patches</strong> + <strong>3
                        r√©gressions vertes</strong>.
                </div>
            </div>

            <button
                class="text-left p-4 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition-colors"
                data-page="tech_06d_security_labs">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-[10px] uppercase tracking-widest text-slate-500 mb-1">Fin</div>
                        <div class="text-white font-bold">Hub ‚Äî Security Labs</div>
                    </div>
                    <i data-lucide="home" class="w-5 h-5 text-rose-400"></i>
                </div>
            </button>
        </div>
    </section>

</div>

    <div class="text-center mt-4">
        <p class="text-xs text-slate-400">Source technique : <a class="underline" href="../../tech/chapters/tech_06d2_security_labs_n2.html">tech: Security Labs N2 (d√©tails techniques)</a></p>
    </div>